<!DOCTYPE html>
<!-- saved from url=(0047)https://tobys-website-7b6b12.webflow.io/testing -->
<html
  data-wf-domain="tobys-website-7b6b12.webflow.io"
  data-wf-page="668f1fad8ce1f487a65387d6"
  data-wf-site="6663647809c4c391f5112711"
  lang="en"
  class="w-mod-js w-mod-ix wf-inter-n1-inactive wf-inter-n7-inactive wf-inter-n9-inactive wf-inter-n5-inactive wf-inter-n2-inactive wf-inter-n3-inactive wf-inter-n6-inactive wf-inter-n4-inactive wf-inter-n8-inactive wf-sora-n1-inactive wf-sora-n2-inactive wf-sora-n8-inactive wf-sora-n4-inactive wf-sora-n6-inactive wf-sora-n7-inactive wf-sora-n5-inactive wf-sora-n3-inactive wf-manrope-n7-inactive wf-manrope-n6-inactive wf-manrope-n3-inactive wf-manrope-n8-inactive wf-manrope-n2-inactive wf-manrope-n5-inactive wf-manrope-n4-inactive wf-inactive"
>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <style>
      .wf-force-outline-none[tabindex="-1"]:focus {
        outline: none;
      }
    </style>
    <title>testing</title>
    <link
      rel="alternate"
      hreflang="x-default"
      href="https://tobys-website-7b6b12.webflow.io/testing"
    />
    <link
      rel="alternate"
      hreflang="en"
      href="https://tobys-website-7b6b12.webflow.io/testing"
    />
    <link
      rel="alternate"
      hreflang="es"
      href="https://tobys-website-7b6b12.webflow.io/es/testing"
    />
    <meta content="testing" property="og:title" />
    <meta content="testing" property="twitter:title" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <link
      href="./testing_files/tobys-website-7b6b12.webflow.4b0967246.css"
      rel="stylesheet"
      type="text/css"
    />
    <link href="https://fonts.googleapis.com/" rel="preconnect" />
    <link
      href="https://fonts.gstatic.com/"
      rel="preconnect"
      crossorigin="anonymous"
    />
    <script
      src="./testing_files/webfont.js.download"
      type="text/javascript"
    ></script>
    <link rel="stylesheet" href="./testing_files/css" media="all" />
    <script type="text/javascript">
      WebFont.load({
        google: {
          families: [
            "Sora:100,200,300,regular,500,600,700,800",
            "Inter:100,200,300,regular,500,600,700,800,900",
            "Manrope:200,300,regular,500,600,700,800",
          ],
        },
      });
    </script>
    <script type="text/javascript">
      !(function (o, c) {
        var n = c.documentElement,
          t = " w-mod-";
        (n.className += t + "js"),
          ("ontouchstart" in o ||
            (o.DocumentTouch && c instanceof DocumentTouch)) &&
            (n.className += t + "touch");
      })(window, document);
    </script>
    <link
      href="https://cdn.prod.website-files.com/6663647809c4c391f5112711/66789ed1dc0f4c48da4d5f8f_toby_favicon_black.png"
      rel="shortcut icon"
      type="image/x-icon"
    />
    <link
      href="https://cdn.prod.website-files.com/img/webclip.png"
      rel="apple-touch-icon"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        background-color: #f4f4f4;
      }
      h1 {
        color: #333;
      }
      #audio-controls {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 20px;
      }
      .control-button {
        background: none;
        border: none;
        cursor: pointer;
        transition: transform 0.1s ease-in-out;
      }
      .control-button:hover {
        transform: scale(1.1);
      }
      .control-button img {
        width: 50px;
        height: 50px;
      }
      #transcription-container {
        max-width: 600px;
        width: 100%;
        margin: 0 auto;
        text-align: center;
      }
      #transcription {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        min-height: 100px;
        border: 1px solid #ddd;
        margin-top: 10px;
      }
    </style>
  </head>
  <body class="body-4">
    <div>
      <h1>Testing Sandbox<br />‚Äç</h1>
    </div>
    <div id="audio-controls" class="w-clearfix">
      <div class="w-form">
        <form
          id="email-form"
          name="email-form"
          data-name="Email Form"
          method="get"
          data-wf-page-id="668f1fad8ce1f487a65387d6"
          data-wf-element-id="00207763-118d-3ae2-121b-5dd73eabb87f"
          aria-label="Email Form"
        >
          <select
            id="inputLanguage"
            name="Input-Language"
            data-name="Input Language"
            class="w-select"
          >
            <option value="eng">English</option>
            <option value="eng">English</option>
            <option value="fra">French</option>
            <option value="spa">Spanish</option></select
          ><select
            id="outputLanguage"
            name="Input-Language-2"
            data-name="Input Language 2"
            class="w-select"
          >
            <option value="eng">English</option>
            <option value="eng">English</option>
            <option value="fra">French</option>
            <option value="spa">Spanish</option></select
          ><select
            id="originalVolumeSlider"
            name="Original-Audio-Volume"
            data-name="Original Audio Volume"
            class="w-select"
          >
            <option value="0">0</option>
            <option value="0.25">0.25</option>
            <option value="0.5">0.5</option>
            <option value="0.75">0.75</option>
            <option value="1">1</option></select
          ><select
            id="Translated-Audio-Volume"
            name="Translated-Audio-Volume"
            data-name="Translated Audio Volume"
            class="w-select"
          >
            <option value="0">0</option>
            <option value="0.25">0.25</option>
            <option value="0.5">0.5</option>
            <option value="0.75">0.75</option>
            <option value="1">1</option>
          </select>
        </form>
        <div
          class="w-form-done"
          tabindex="-1"
          role="region"
          aria-label="Email Form success"
        >
          <div>Thank you! Your submission has been received!</div>
        </div>
        <div
          class="w-form-fail"
          tabindex="-1"
          role="region"
          aria-label="Email Form failure"
        >
          <div>Oops! Something went wrong while submitting the form.</div>
        </div>
      </div>
      <a id="startButton" class="w-button">Start</a
      ><a id="stopButton" class="button-2 w-button" style="display: none"
        >Stop</a
      >
    </div>
    <div id="transcription-container">
      <h3>Transcription:</h3>
      <p id="transcription"></p>
    </div>
    <div id="translation-container">
      <h3>Translation:</h3>
      <p id="translation"></p>
    </div>
    <div id="audioPlayer" class="w-embed">
      <audio id="audioPlayer" style="display: none"></audio>
    </div>
    <script
      src="./testing_files/jquery-3.5.1.min.dc5e7f18c8.js.download"
      type="text/javascript"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"
    ></script>
    <script
      src="./testing_files/webflow.9fac3cfc2.js.download"
      type="text/javascript"
    ></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js"></script>
    <script>
      let socket;
      let audioContext;
      let source;
      let processor;
      let resampler;
      let mediaRecorder;
      let audioBuffer = [];
      let fileBuffer = [];
      let audioQueue = [];
      let isPlaying = false;
      const SAMPLE_RATE = 16000;
      const BUFFER_SIZE = SAMPLE_RATE * 0.35; // 350ms

      console.log("Socket.IO library loaded:", typeof io !== "undefined");

      // ################################################################################
      // ############################### Setup/Config ###################################
      // ################################################################################
      // Connect socket immediately and keep it connected
      function connectSocket() {
        if (!socket || !socket.connected) {
          socket = io("ws://35.232.33.243", {
            path: "/ws/socket.io",
            transports: ["websocket"],
            query: {
              clientID: "C0B44AA770541DBCAE4AE4255BCE7598",
            },
          });

          socket.on("connect", () => {
            console.log("Connected to WebSocket server");
            updateLanguages();
          });

          socket.on("connect_error", (error) => {
            console.error("Connection error:", error);
          });
        }
      }

      // Call this function immediately to establish the connection
      connectSocket();

      function updateLanguages() {
        const inputLang = document.getElementById("inputLanguage").value;
        const outputLang = document.getElementById("outputLanguage").value;

        const languages = [inputLang, outputLang];
        const config = {
          async_processing: true,
          buffer_limit: 1,
          channels: [1],
          client_id: "C0B44AA770541DBCAE4AE4255BCE7598",
          debug: false,
          model_name: "Skopos",
          model_type: "s2s&t",
          rate: SAMPLE_RATE,
        };

        socket.emit("update_languages", languages, config);
        console.log("Sent update_languages event:", languages, config);
      }

      // Add event listeners to language selects
      document
        .getElementById("inputLanguage")
        .addEventListener("change", updateLanguages);
      document
        .getElementById("outputLanguage")
        .addEventListener("change", updateLanguages);

      // ################################################################################
      // ############################### incoming_audio #################################
      // ################################################################################

      function sendAudioToServer(audioData) {
        console.log(
          "sendAudioToServer called with data length:",
          audioData.length
        );

        // Add new audio data to the buffer
        audioBuffer = audioBuffer.concat(Array.from(audioData));

        // Check if we have enough data to send
        if (audioBuffer.length >= BUFFER_SIZE) {
          const dataToSend = audioBuffer.slice(0, BUFFER_SIZE);
          audioBuffer = audioBuffer.slice(BUFFER_SIZE);

          // Ensure we're not sending silent audio
          if (dataToSend.every((sample) => Math.abs(sample) < 0.01)) {
            console.log("Skipping silent audio");
            return;
          }

          const int16Array = new Int16Array(dataToSend.length);
          for (let i = 0; i < dataToSend.length; i++) {
            const s = Math.max(-1, Math.min(1, dataToSend[i]));
            int16Array[i] = s < 0 ? s * 0x8000 : s * 0x7fff;
          }

          // Convert Int16Array to Uint8Array
          const uint8Array = new Uint8Array(int16Array.buffer);

          // Send the Uint8Array directly
          socket.emit(
            "incoming_audio",
            {
              channel: 1,
              audioData: uint8Array,
            },
            (response) => {
              console.log("Server response:", response);
            }
          );
        }
      }

      function startRecording() {
        navigator.mediaDevices
          .getUserMedia({ audio: true })
          .then((stream) => {
            audioContext = new (window.AudioContext ||
              window.webkitAudioContext)({ sampleRate: SAMPLE_RATE });
            source = audioContext.createMediaStreamSource(stream);
            processor = audioContext.createScriptProcessor(1024, 1, 1);

            source.connect(processor);
            processor.connect(audioContext.destination);

            processor.onaudioprocess = function (e) {
              const inputData = e.inputBuffer.getChannelData(0);
              fileBuffer = fileBuffer.concat(Array.from(inputData));
              sendAudioToServer(inputData);
            };

            document.getElementById("startButton").style.display = "none";
            document.getElementById("stopButton").style.display =
              "inline-block";
          })
          .catch((e) => console.error("Error accessing microphone:", e));
      }

      function stopRecording() {
        if (processor && source) {
          processor.disconnect();
          source.disconnect();
          audioContext.close();
        }
        var fileBufferStr = fileBuffer.join("\n");

    // Create a blob from the string
    var blob = new Blob([fileBufferStr], { type: "text/plain;charset=utf-8" });

    // Create a link element
    var a = document.createElement("a");

    // Set link download attribute with filename
    a.download = "record.txt";

    // Create an object URL for the blob
    a.href = URL.createObjectURL(blob);

    // Append the link to the body
    document.body.appendChild(a);

    // Start download
    a.click();

    // Clean up
    document.body.removeChild(a);

    // Clear the audio buffer
    console.log(typeof(fileBuffer), fileBuffer);
        // Clear the audio buffer
        console.log(typeof(fileBuffer), fileBuffer);
        audioBuffer = [];
        document.getElementById("startButton").style.display = "inline-block";
        document.getElementById("stopButton").style.display = "none";
      }

      // ################################################################################
      // ############################### SOCKET AUDIO ###################################
      // ################################################################################

      socket.on("translation_speech", (data) => {
        console.log("Received translated audio");

        // Use audioData["payload"] and create an AudioBuffer
        const audioData = data.payload;
        const sampleRate = data.sample_rate;

        if (!audioContext) {
          audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
        }

        const audioBuffer = audioContext.createBuffer(
          1,
          audioData.length,
          sampleRate
        );
        const channelData = audioBuffer.getChannelData(0);
        for (let i = 0; i < audioData.length; i++) {
          channelData[i] = audioData[i];
        }

        // Add the audio buffer to the queue
        audioQueue.push(audioBuffer);

        // If not currently playing, start playing
        if (!isPlaying) {
          playNextAudio();
        }
      });

      function playNextAudio() {
        if (audioQueue.length === 0) {
          isPlaying = false;
          return;
        }

        isPlaying = true;
        const audioBuffer = audioQueue.shift();

        const source = audioContext.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(audioContext.destination);
        source.start();

        source.onended = () => {
          playNextAudio(); // Play the next audio in the queue
        };
      }
      // ################################################################################
      // ############################### SOCKET TEXT ####################################
      // ################################################################################
      // Event listener for transcription text
      socket.on("transcription_text", (data) => {
        const transcriptionElement = document.getElementById("transcription");
        if (transcriptionElement) {
          // Assuming the data structure is similar to the audio data
          const text = data.payload || data;
          transcriptionElement.textContent = text;
          console.log("Transcription updated:", text);
        } else {
          console.error("Transcription element not found");
        }
      });

      // Event listener for translation text
      socket.on("translation_text", (data) => {
        const translationElement = document.getElementById("translation");
        if (translationElement) {
          // Assuming the data structure is similar to the audio data
          const text = data.payload || data;
          translationElement.textContent = text;
          console.log("Translation updated:", text);
        } else {
          console.error("Translation element not found");
        }
      });

      // Function to create or update text containers
      function createOrUpdateTextContainers() {
        const containers = [
          {
            id: "transcription-container",
            title: "Transcription",
            contentId: "transcription",
          },
          {
            id: "translation-container",
            title: "Translation",
            contentId: "translation",
          },
        ];

        containers.forEach((container) => {
          let containerElement = document.getElementById(container.id);
          if (!containerElement) {
            containerElement = document.createElement("div");
            containerElement.id = container.id;
            document.body.appendChild(containerElement);
          }

          containerElement.innerHTML = `
            <h3>${container.title}:</h3>
            <p id="${container.contentId}"></p>
        `;
        });
      }

      // Call this function when the page loads
      document.addEventListener(
        "DOMContentLoaded",
        createOrUpdateTextContainers
      );

      socket.on("connect_error", (error) => {
        console.error("Connection error:", error);
      });

      socket.on("error", (error) => {
        console.error("Socket error:", error);
      });

      // ################################################################################
      // ############################### UI #############################################
      // ################################################################################
      document
        .getElementById("startButton")
        .addEventListener("click", startRecording);
      document
        .getElementById("stopButton")
        .addEventListener("click", stopRecording);

      // Initially hide the stop button
      document.getElementById("stopButton").style.display = "none";
    </script>
  </body>
</html>
